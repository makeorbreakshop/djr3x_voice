# DJ Mode Implementation Plan

## üéØ Concept Overview
DJ R3X will function as an autonomous DJ that:
- Plays through music tracks automatically with intelligent sequencing
- Provides DJ-style introductions for upcoming tracks
- Creates smooth crossfades between songs
- Continues operating in the background without user input

## üèóÔ∏è Architecture Changes

This section details the components involved in DJ Mode, emphasizing adherence to `ARCHITECTURE_STANDARDS.md` and `SERVICE_TEMPLATE_GUIDELINES.md`.

### New Components
1. **CachedSpeechService**
   - Pre-renders speech for precise timing control
   - Provides exact speech duration information
   - Enables synchronized music/voice transitions
   - Implements lookahead caching for transitions (current + next track) - Must follow `ARCHITECTURE_STANDARDS.md` Section 10 (Audio Processing Standards) for threading.

### Modified Components
1. **MusicControllerService**
   - Add crossfade capability between tracks
   - Support pre-loading of next track
   - Expose track metadata for better transitions
   - Add methods to get precise track progress/remaining time
   - Emit TRACK_ENDING_SOON events when track nears completion

2. **BrainService**
   - Generate plans for DJ mode transitions (just-in-time planning)
   - Implement intelligent track sequencing algorithms
   - Orchestrates commentary generation via GPTService
   - Orchestrates caching via CachedSpeechService
   - Handle DJ CLI commands (next, stop, etc.) - Must integrate with `CommandDispatcherService` per `ARCHITECTURE_STANDARDS.md` Section 9.
   - Create transition plans for skip commands

3. **TimelineExecutorService**
   - Support coordinated transitions between tracks - Execution of plans generated by BrainService.
   - Handle speech/music synchronization with precise timing - Must follow `ARCHITECTURE_STANDARDS.md` Section 10 (Audio Processing Standards) for precise audio control.
   - Manage layer transitions during crossfades

4. **MemoryService**
   - Store DJ mode state (active/inactive)
   - Track current playlist and play history
   - Remember user preferences and skip patterns
   - Maintain lookahead cache state

## üìù Implementation Checklist

### Phase 1: Core Infrastructure
- [x] Create CachedSpeechService
  - [x] Speech pre-generation functionality
  - [x] Implement lookahead caching system (current + skip track) - Ensure continuous caching loop while track is playing.
  - [x] Duration calculation and metadata
  - [x] Playback with precise timing
  - [x] Implement audio playback for cached speech in a separate thread to avoid blocking the event loop (`ARCHITECTURE_STANDARDS.md` Section 10.1).
  - [x] Thread-safe implementation per audio standards - Adhere strictly to `ARCHITECTURE_STANDARDS.md` Section 10.

- [x] Add crossfade capabilities to MusicControllerService
  - [x] Implement volume ramping for fade-out
  - [x] Add secondary track player for fade-in
  - [x] Create crossfade timing controls
  - [x] Support track pre-loading
  - [x] Add track progress/completion detection - Emit `TRACK_ENDING_SOON` event.

- [x] Add DJ Mode CLI commands
  - [x] `dj start` - Begin DJ mode
  - [x] `dj stop` - Exit DJ mode
  - [x] `dj next` - Force next track
  - [ ] `dj queue <track>` - Queue specific track
  - [x] Ensure commands are registered correctly in `main.py` via `CommandDispatcherService` (`ARCHITECTURE_STANDARDS.md` Section 9).

### Phase 2: DJ Intelligence
- [x] Enhance BrainService for DJ mode planning
  - [x] Implement track synchronization with MusicControllerService
  - [x] Create shared music models (MusicTrack, MusicLibrary)
  - [x] Add track selection improvements to avoid repetition
  - [x] Event handler for TRACK_ENDING_SOON
  - [x] Just-in-time plan generation for transitions
  - [x] CLI command handling for DJ controls
  - [x] Track sequencing algorithm with genre/energy matching
  - [x] Interaction with MemoryService for state tracking
  - [x] Create new GPT Persona for DJ R3X intros and transitions. (Fulfilled by cantina_os/dj_r3x-transition-persona.txt)
  - [x] Implement logic to provide track metadata to GPTService for commentary generation.
  - [x] Implement continuous background task to generate and cache *next* transition commentary while current track plays.
  - [x] Implement logic in BrainService to receive `TRACK_ENDING_SOON` events and trigger the execution of the corresponding cached timeline plan.
  - [x] Implement logic in BrainService to handle `DJ_NEXT` command by activating the cached timeline plan.

- [x] DJ mode state persistence

- [x] Create DJ commentary generator
  - [x] Track-specific intros based on metadata
  - [x] Transition commentary between genres
  - [x] Special commentary for mood shifts
  - [x] Time-of-day appropriate remarks

### Phase 3: Timeline Integration
- [x] Enhance TimelineExecutorService for DJ mode
  - [x] Coordinated layer management during transitions
  - [x] Precise timing for crossfades and speech
  - [x] Dynamic plan handling for DJ mode transitions
  - [x] Ambient layer management with music

- [x] Implement event system for DJ mode
  - [x] `DJ_MODE_CHANGED` event
  - [x] `TRACK_ENDING_SOON` event (30 seconds before end) - Payload should include track data.
  - [x] `CROSSFADE_STARTED` event
  - [x] `DJ_COMMENTARY_NEEDED` event - Triggered by BrainService to request commentary.
  - [x] `DJ_NEXT_TRACK` event (for CLI skip command)
  - [x] `MUSIC_LIBRARY_UPDATED` event (for track synchronization)
  - [x] `SPEECH_CACHE_REQUEST/READY/ERROR/CLEANUP` events - Payloads must use Pydantic models per `ARCHITECTURE_STANDARDS.md` Section 8 and `SERVICE_TEMPLATE_GUIDELINES.md` Section 5.
  - [x] Define Pydantic models for all DJ mode related event payloads (if not already done in `event_payloads.py`).
  - [x] Ensure `TimelineExecutorService` can accept and execute the specific Plan structure generated by `BrainService` for DJ transitions (crossfade, voice, ducking).

### Phase 4: Testing & Refinement
- [ ] Create test suite for DJ mode
  - [x] Tests for CachedSpeechService
  - [ ] Automated tests for crossfades
  - [ ] Timing verification for speech/music sync
  - [ ] Long-running stability tests
  - [x] Test for CLI command handling

- [x] Performance optimization
  - [x] Cache management efficiency
  - [x] Memory usage during extended sessions
  - [x] CPU load during crossfades

## üîÑ Event Flow for DJ Mode

This flow outlines the process triggered by `dj start` and subsequent automatic transitions.
**ARCHITECTURAL PRINCIPLE: All audio/speech coordination flows through TimelineExecutorService for consistency.**

```
[DJ Mode Active] (via 'dj start' command -> CommandDispatcher -> BrainService)
        |
        v
[BrainService selects 1st track & plans initial intro]
        |
        v
[MusicControllerService starts playing 1st track]
        |
        v
[BrainService requests initial intro commentary from GPTService (with track data)]
        |
        v
[GPTService generates intro text]
        |
        v
[BrainService creates Timeline Plan for initial commentary with speak step]
        |
        v
[TimelineExecutorService executes initial commentary plan]:
    - Music ducked (Timeline Layer)
    - Streaming TTS audio plays via speak step
    - Music unduck after completion
        |
        v
[Initial intro complete, full music volume restored]
        |
        v
[CONTINUOUS BACKGROUND PROCESS (in BrainService/DJ state manager)]
        |
        ‚îú‚îÄ‚îÄ> [While Current Track Playing]:
        |         |
        |         v
        |   [BrainService selects NEXT track & plans transition commentary]
        |         |
        |         v
        |   [BrainService requests NEXT transition commentary from GPTService (with current & next track data)]
        |         |
        |         v
        |   [GPTService generates transition text]
        |         |
        |         v
        |   [BrainService requests cached audio from ElevenLabsService via CachedSpeechService]
        |         |
        |         v
        |   [CachedSpeechService stores audio & metadata (Lookahead Cache is READY)]
        |         |
        |         v
        |   [BrainService creates Timeline Plan for NEXT transition with PlayCachedSpeechStep & submits]
        |         |
        |         v
        |   [TimelineExecutorService holds Plan, ready for trigger]
        |
        ‚îî‚îÄ‚îÄ> (Continues until trigger)
        |
        v
[TRIGGER: TRACK_ENDING_SOON event OR DJ_NEXT command]
        |
        v
[BrainService activates corresponding Timeline Plan]
        |
        v
[TimelineExecutorService executes Plan]:
    - Cached voice commentary plays (Timeline Layer)
    - MusicControllerService crossfades tracks (music ducked)
        |
        v
[Transition Complete, New Track Playing]
        |
        v
[Return to CONTINUOUS BACKGROUND PROCESS]
```

## üîÑ CLI Skip Command Flow

```
[DJ_NEXT command received] (via CommandDispatcher -> BrainService)
        |
        v
[BrainService checks Lookahead Cache status]
        |
        ‚îú‚îÄ‚îÄ [Cache is READY] Activate the already submitted Timeline Plan for NEXT transition.
        |         |
        |         v
        |     [TimelineExecutorService executes Plan (Cached voice + Crossfade + Ducking)]
        |         |
        |         v
        |     [Transition Complete, New Track Playing]
        |         |
        |         v
        |     [Return to CONTINUOUS BACKGROUND PROCESS]
        |
        ‚îî‚îÄ‚îÄ [Cache NOT READY] Generate and cache transition on-demand (may cause delay).
                |   (Follows the 'Generate/Cache NEXT Transition' steps above, then executes Plan)
                v
            [Execute skip plan (may be less smooth)]
```

## üö© Expected Challenges
1. **Speech Timing Precision**: Ensuring DJ commentary aligns perfectly with musical transitions during Timeline execution.
2. **Resource Management**: Handling memory usage with pre-cached audio files and managing background caching tasks.
3. **Musical Flow**: Creating algorithms that select tracks with complementary musical qualities.
4. **Stability**: Ensuring the system can run for hours without degradation, including robust error handling (following `ARCHITECTURE_STANDARDS.md` Section 2).
5. **Content Variety**: Preventing repetitive DJ commentary over extended sessions.
6. **Lookahead Cache Management**: Balancing responsiveness (cache ready when needed) with resource usage (memory, CPU for generation/caching).
7. **Aligning with Architecture**: Ensuring all new and modified components strictly follow `ARCHITECTURE_STANDARDS.md` and `SERVICE_TEMPLATE_GUIDELINES.md` (Service Structure, Event Handling, Task Management, Audio Processing, etc.).
8. **Sounddevice Threading**: Correctly implementing `sounddevice` audio playback within a dedicated thread in `CachedSpeechService` to avoid blocking the asyncio event loop.

## üîß Technical Requirements
- ElevenLabs API integration via TimelineExecutorService (streaming via speak steps, cached via PlayCachedSpeechStep)
- Audio buffer and track analysis capability
- Thread-safe cache management - Strict adherence to `ARCHITECTURE_STANDARDS.md` Section 10 Threading Model.
- Modification of `CachedSpeechService` audio playback to use a separate thread (`asyncio.run_in_executor`).
- Event-driven architecture compatible with existing timeline services - Using `EventTopics` enum and Pydantic Payloads.
- Precise audio timing for crossfades and voice synchronization via TimelineExecutorService coordination.
- Integration with `CommandDispatcherService` for CLI commands.
- Implementation of new GPT Persona.
- **Unified Timeline Architecture**: All audio/speech coordination flows through TimelineExecutorService for consistency.

This implementation plan leverages our existing layered timeline architecture by using BrainService as the primary plan generator, MemoryService for state tracking, and TimelineExecutorService for coordinated execution of BOTH initial and transition commentary. The lookahead caching approach balances responsiveness with resource efficiency. Strict adherence to the project's `ARCHITECTURE_STANDARDS.md` and `SERVICE_TEMPLATE_GUIDELINES.md` is critical for successful implementation.

- [x] Track history tracking for repetition avoidance
- [x] User preference storage
- [x] Lookahead cache state management 